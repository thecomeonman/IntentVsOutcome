---
title: "Finding passers with good awareness"
output: md_document
---

## Note

This is almost exactly what's been done in http://www.lukebornn.com/papers/fernandez_sloan_2019.pdf. This is a valuable lesson in why you shouldn't let items on your reading list hang around for so long that you don't even remember to read them when working on something which is almost the exact same thing for which you have written thousands of lines of code. FML. You can read the rest of the text anyway for an ELI5 idea of what's being done in the paper. The models are not similar at all but the principal remains.

The only novel part in this article, unless there is another paper about this that I haven't read yet, is the idea behind the 'Adjusting for passing ability' bit. Like how we distinguish xG from PSxG, we need to distinguish intention from outcome for passing as well. Read more about it in the 'Adjusting for passing ability' section.

## Introduction

Using possession value (PV) to measure the value of the actions of players is a commonly seen statistic on Twitter now, and that too specifically for the passes and carries that player executed or the passes the player received. As with most analysis using only event data, this disregards the context in which those passes were played, or the role of the player. I've been thinking about how to incorporate this element.

Using pitch control, we can estimate the probability of players controlling the ball in various parts of the pitch so we could simulate all the realistic options for a passes possible at any point in the game to estimate how much value a player _could_ have added from passes they _could_ have made or received compared to the pass they actually made or received. Note that this is not the same as estimating the value of their off ball actions but more like an adjustment for the fact that not every player in the team will receive as many passes, good opportunities to pass to them might get missed because of reasons beyond their control, the situation may influence their choice of pass, etc.

This is a thinking out loud kind of post. A bunch of basic charts and numbers are here which should be enough to give an idea of what I'm proposing. I want to think about this some more, which is usually a long and slow process because life gets in the way, before doing a version with nice looking vizes, etc. + also get feedback and comments from you guys, the readers.

```{r setup, include=FALSE}

rm(list = ls())

library(data.table)
library(ggplot2)
library(scales)
library(CodaBonito)
library(knitr)

knitr::opts_chunk$set(
   echo = F,
   message = F,
   warning = F,
   fig.width = 12,
   fig.height = 6
)

```

```{r parameters, echo=FALSE}

cRootDirectory = '~/Desktop/Data/Projects/Personal'

nXSpan = 120
nYSpan = 80
nUpperLimitSpeed = 5 * 120 / 105

cGameName = 'Sample_Game_1'

dtPlayerLabels = rbind(
   data.table(
      Player = paste0(c(''), 2:12),
      Label = c(
         'RCB',
         'LCB',
         'LB',
         'RW',
         'LCM',
         'RB',
         'LW',
         'CF',
         'CAM',
         'GK',
         'RCM'
      )
   ),
   data.table(
      Player = paste0(c(''), 15:25),
      Label = c(
         'RCB',
         'CB',
         'RWB',
         'CM',
         'RCM',
         'LCB',
         'LCM',
         'LWB',
         'LF',
         'RF',
         'GK'
      )
   )
)

dtPlayerLabels[,
   Label := factor(
      Label,
      levels = c(
         'GK',
         'RCB','CB','LCB',
         'RB','LB','RWB','LWB',
         'CDM',
         'RCM','CM','LCM',
         'RW','RCAM','CAM','LCAM','LW',
         'RF','CF','LF'
      ),
      ordered = T
   )
]

TeamDeltaPVThreshold = 0.02
PlayerDeltaPVThreshold = 0.01

DataFrequency_hz = 25
```

```{r functions, echo=FALSE}


  fGetEPV = function(
    vnX,
    vnY,
    nXSpan = 120,
    nYSpan = 80
  ) {
    
    dtEPV = fread(
        'https://raw.githubusercontent.com/Friends-of-Tracking-Data-FoTD/LaurieOnTracking/master/EPV_grid.csv',
        header = F
    )

    vnEPVGridX = seq(0, nXSpan, nXSpan/ncol(dtEPV))
    vnEPVGridY = seq(0, nYSpan, nYSpan/nrow(dtEPV))
    
    # vnEPVGridX[1] = vnEPVGridX[1] - 0.000000001
    # vnEPVGridY[1] = vnEPVGridY[1] - 0.000000001
    
    vnX = vnX + (nXSpan/2)
    vnY = vnY + (nYSpan/2)
    
    vnX = 1 + ( vnX %/% (nXSpan/ncol(dtEPV)) )
    vnX[vnX <= 0] = 1L
    vnX[vnX > ncol(dtEPV)] = ncol(dtEPV)
    vnY = 1 + ( vnY %/% (nYSpan/nrow(dtEPV)) )
    vnY[vnY <= 0] = 1L
    vnY[vnY > nrow(dtEPV)] = nrow(dtEPV)
    
    dtEPV[, Y := .I]
    dtEPV = melt(dtEPV, 'Y')
    dtEPV[, X := as.integer(gsub(variable, pattern = 'V', replacement = ''))]

    merge(
      data.table(X = vnX, Y = vnY)[, SNO := .I],
      dtEPV,
      c('X','Y')
    )[order(SNO), value]
    
  }

```

```{r data, echo=FALSE}

if ( F ) {
      
   lData = fParseTrackingDataBothTeams(
      cRootPath = file.path(cRootDirectory,'/sample-data/data/'),
      cGameName = cGameName,
      nXSpan = nXSpan,
      nYSpan = nYSpan,
      xMaxBB = 1,
      yMaxBB = 1,
      nUpperLimitSpeed = nUpperLimitSpeed
   )
   
}


load(file.path(cRootDirectory, 'PassingAwareness/PVDelta.Rdata'))

dtPVDelta[, Team := Tag]
dtPVDelta[Tag == 'A', BallX := -BallX]
dtPVDelta[Tag == 'A', BallY := -BallY]
dtPVDelta[Tag == 'A', PlayerMaxDeltaPVX := -PlayerMaxDeltaPVX]
dtPVDelta[Tag == 'A', PlayerMaxDeltaPVY := -PlayerMaxDeltaPVY]
dtPVDelta[Tag == 'A', TeamMaxDeltaPVX := -TeamMaxDeltaPVX]
dtPVDelta[Tag == 'A', TeamMaxDeltaPVY := -TeamMaxDeltaPVY]

dtPVDelta[Tag == 'A', PlayerMaxDeltaPVRealisticX := -PlayerMaxDeltaPVRealisticX]
dtPVDelta[Tag == 'A', PlayerMaxDeltaPVRealisticY := -PlayerMaxDeltaPVRealisticY]
dtPVDelta[Tag == 'A', TeamMaxDeltaPVRealisticX := -TeamMaxDeltaPVRealisticX]
dtPVDelta[Tag == 'A', TeamMaxDeltaPVRealisticY := -TeamMaxDeltaPVRealisticY]

```

## Methodology

### Pitch Control

Pitch control tells you the probability of a team and its players controlling the ball at various parts of the pitch if the ball were to be passed there. This is done for each instant of the game and changes based on the positions of the players and their movement. 

I use Spearman's model but you could probably swap it out for any other model too.

### Possession Value

The probability of scoring at the end of a play / in the next some moves / in the next some seconds once the team has a ball in a particular part of the pitch.

I've used the PV grid at https://raw.githubusercontent.com/Friends-of-Tracking-Data-FoTD/LaurieOnTracking/master/EPV_grid.csv which looks like this for the team attacking left to right -

```{r PVParms, echo=FALSE}

if ( F ) {
   
   nCompoundingFactor = 1
   nNumeratorFactor = 0.9
   
   ggplot() + 
      geom_line(
         data = data.table(
            Distance = seq(
               0,
               ceiling(
                  ( 
                     ( 120 ^ 2 ) +
                     ( 40 ^ 2 )
                  ) ^ ( 0.5 * nCompoundingFactor )
               ),
               1
            )
         )[,
            PV := nNumeratorFactor / ( Distance + 1 )
         ],
         aes(
            x = Distance,
            y = PV
         )
      ) +
      labs(
         x = 'Distance from goal',
         y = 'Possession value'
      ) +
      scale_y_continuous(labels = percent)
   
} else if ( T ) {
   
   dtPitchGrid = expand.grid(
      x = seq(-nXSpan/2, nXSpan/2, 1),
      y = seq(-nYSpan/2, nYSpan/2, 1)
   )
   setDT(dtPitchGrid)
   
   dtPitchGrid[,
      PV := fGetEPV(
         x,
         y
      )
   ]
   
   p1 = ggplot(dtPitchGrid) +
      geom_tile(
        aes(x = x, y = y, fill = PV)
       ) +
       geom_pitch(cPitchColour = 'transparent', cLineColour = '#CCCCCC') +
       scale_fill_continuous(low = 'white', high = 'red', limits = c(0,1), labels = percent) +
       theme_pitch()
   
   print(p1)
   
}

```

We can rotate the pitch 180 degrees and get the PV values for the respective part of the pitch for the opposition since that team is attacking right to left.

Note how the probability sharply climbs close to 50% near the opposition goal but is quite low for most of the pitch.

You should be able to swap it out for another PV model, if you so prefer.

### Combining Pitch Control and Possession Value

You should be able to combine these to evaluate what passing options offer progress to the team in possession.

- The team in possession already has a certain PV depending on where they have the ball: `AttackingOriginPV`
- The defending team is equally at risk of conceding a goal from that position, so the `DefendingingOriginPV = -AttackingOriginPV`
- Assuming it is possible to pass to every point on the pitch, `(x,y)`, the PV for each target location can be calculated for both the teams, `AttackingTargetPV_xy` and `DefendingTargetPV_xy`
- At every point on the pitch, `(x,y)`, the attacking team has a probability of keeping control of the ball, `AttackingTeamProbabilty_xy`, and therefore the defending team's probability is `DefendingTeamProbabilty_xy = 1 - AttackingTeamProbabilty_xy`
- At every point, `(x,y)`, we can estimate an expected PV for playing a pass there:
   - For the attacking team, `ExpectedAttackingTargetPV = ( AttackingTeamProbabilty_xy * AttackingTargetPV_xy ) - ( DefendingTeamProbabilty_xy * DefendingTargetPV_xy )`
   - For the defending team, which is the same as the above formula with the attacking / defending terms exchanged, `ExpectedDefendingTargetPV = ( DefendingTeamProbabilty_xy * DefendingTargetPV_xy ) - ( AttackingTeamProbabilty_xy * AttackingTargetPV_xy )`
- The change in PV from the current position can be calculated as the difference of the above terms from the PV of the starting position:
    - For the attacking team, `ExpectedAttackingDeltaPV_xy = ExpectedAttackingTargetPV_xy - AttackingOriginPV`
    - For the defending team, `ExpectedDefendingDeltaPV_xy = ExpectedDefendingTargetPV_xy - DefendingOriginPV`

Given we know the PV of each part of the pitch for both teams, and we know that the probability of controlling the ball for both teams must add up to 1 in each part of the pitch, we can calculate the minimum value `ExpectedAttackingTargetPV_xy` must be in each part of the pitch for it to compensate for `ExpectedDefendingDeltaPV_xy`, and therefore we can also calculate the minimum value `AttackingTeamProbabilty_xy` should be for `ExpectedAttackingTargetPV_xy` to attain the necessary value. Think of this value for `AttackingTeamProbabilty_xy` as a kind of breakeven probability. This is what those probabilities look like -

```{r PVBreakEven, echo=FALSE}

dtPitchGrid = merge(dtPitchGrid,dtPitchGrid[, list(x = -x, y = -y, OppositionPV = PV)], c('x','y'))

dtPitchGrid[, BreakevenProbability := OppositionPV / ( PV + OppositionPV )]

p2 = ggplot(dtPitchGrid) +
   geom_tile(
     aes(x = x, y = y, fill = BreakevenProbability)
    ) +
    geom_pitch(cPitchColour = 'transparent', cLineColour = '#CCCCCC') +
    scale_fill_continuous(low = 'white', high = 'red', limits = c(0,1)) +
    theme_pitch()

print(p2)

```

Note how the breakeven probabilities are very low close to the opposition goal, because in that area the PV is very high for the attacking team compared to the PV for the defending team. In fact right at the goal mouth, the breakeven probability is `r dtPitchGrid[x == nXSpan/2 & y == 0, BreakevenProbability]`. This part of the pitch is a little hard to work with though because goalkeepers are also modelled as outfield players in this pitch control model whereas in reality they would actually exert far greater control than the model gives them credit for because they can use their hands, grab the ball in the air, dive, etc. which the other players cannot do. The pitch control models don't model shots either, it models passes, so the idea of 'passing to the goal' is aso a little odd. We will see later that this situation occurs in very few frames though so for now we will pretend this isn't a problem and carry on. 

I also ignore the possibility of passes that travel more than 2/3 the length of the pitch. Only Ederson can make such passes. We consider the area that is within a radius of 2/3 length of the pitch at any point of time and ignore everything outside of it.

We can expect `ExpectedDefendingDeltaPV_xy` to be positive very often, since `DefendingOriginPV` is a negative value so the more interesting thing to analyse would be `ExpectedAttackingDeltaPV_xy`. A positive `ExpectedAttackingDeltaPV_xy` implies that passing the ball to that point on the pitch is likely to increase the chance of scoring even after considering the risk of conceding the ball.

## Demonstration

### One Frame

I use one frame to give an example of how all that I said above comes together. I chose this example because it also highlights the problem I mentioned above while hopefully also giving you an idea of the concept.

```{r IllustrationData, echo=FALSE}

load(
   file.path(
      cRootDirectory,
      'PassingAwareness',
      'ProgressivePassingOpportunity',
      cGameName,
      'Realistic',
      '2',
      'Results',
      '67776.Rdata'
   )
)

load(
   file.path(
      cRootDirectory,
      'PassingAwareness',
      'ProgressivePassingOpportunity',
      cGameName,
      'Realistic',
      '2',
      'Metadata.Rdata'
   )
)

```

Here is what the pitch control looks like in one of the frames. In my calculations I exclude players that are offside so the two players from the blue team in the offside position have zero contribution to pitch control.

```{r PitchControlIllustation, echo=FALSE}

ggplot() + 
    geom_tile(
        data = lPitchControl$dtDetails,
        aes(x = TargetX, y = TargetY, fill = AttackProbability)
    ) +
    geom_point(
        data = lPitchControl$dtTrackingSlice[Tag == 'B'],
        aes(x = X, y = Y),
        color = 'black',
        size = 3
    ) +
    geom_point(
        data = lPitchControl$dtTrackingSlice[Tag != 'B'],
        aes(x = X, y = Y),
        color = 'black',
        size = 2
    ) +
    geom_point(
        data = lPitchControl$dtTrackingSlice[Tag != 'B'],
        aes(x = X, y = Y),
        color = 'black',
        size = 2
    ) +
    geom_point(
        data = lPitchControl$dtTrackingSlice[Tag != 'B'],
        aes(x = X, y = Y, color = Tag)
    ) +
    geom_pitch(cPitchColour = 'transparent', cLineColour = '#CCCCCC') +
    scale_fill_gradient2(midpoint = 0.5, low = 'red', high = 'blue') +
    theme_pitch()
    
```

When you overlay the possession value and do all those calculations listed above, this is what the pitch looks like in terms of `ExpectedAttackingDeltaPV_xy`.

```{r EPVIllustationTeam, echo=FALSE}

dtDetails = merge(
  lPitchControl$dtDetails[, list(SNO, Frame, TargetX, TargetY)],
  lPitchControl$dtTrackingSlice[
      Player == 0, 
      list(Frame, BallX = X, BallY = Y)
  ],
  'Frame'
)

dtDetails = merge(
  dtDetails,
  lPitchControl$dtTrackingSlice[, 
      list(Frame, Player, Tag, AttackingTeam, TeamInPossession, PlayerInPossession)
  ],
  'Frame',
  allow.cartesian = T
)

dtDetails = merge(
  dtDetails,
  lPitchControl$dtTrackingSliceVectorised[, 
    list(SNO, Player, PlayerPPCF)
  ],
  c('SNO','Player')
)

if ( nrow(dtDetails) == 0 ) {
  stop()
}


if ( lMetadata$cTeam == 'H' ) {
  dtDetails[, OriginPV := fGetEPV(BallX, BallY)]
} else {
  dtDetails[, OriginPV := fGetEPV(-BallX, -BallY)]
}

dtDetails[AttackingTeam != Tag, OriginPV := -OriginPV]

dtDetails[Tag == 'H', TeamTargetPV := fGetEPV(TargetX, TargetY)]
dtDetails[Tag == 'A', TeamTargetPV := fGetEPV(-TargetX, -TargetY)]
dtDetails[Tag == 'H', OppositionTargetPV := fGetEPV(-TargetX, -TargetY)]
dtDetails[Tag == 'A', OppositionTargetPV := fGetEPV(TargetX, TargetY)]


dtDetailsAggregated = dtDetails[, 
  list(
    TeamPPCF = sum(PlayerPPCF)
  ),
  list(
    Frame,
    Tag,
    TargetX,
    TargetY,
    BallX,
    BallY,
    TeamTargetPV,
    OppositionTargetPV,
    OriginPV
  )
]

dtDetailsAggregated[, 
  TeamDeltaPV := (
    ( TeamPPCF * TeamTargetPV ) -
    ( ( 1 - TeamPPCF ) * ( OppositionTargetPV ) )
  ) - (
    1 * OriginPV
  )
]

    
p1 = ggplot() + 
    geom_tile(
        data = dtDetailsAggregated[lPitchControl$dtTrackingSlice[1, AttackingTeam] == Tag],
        aes(x = TargetX, y = TargetY, fill = TeamDeltaPV)
    ) +
    geom_point(
        data = lPitchControl$dtTrackingSlice[Tag == 'B'],
        aes(x = X, y = Y),
        color = 'black',
        size = 3
    ) +
    geom_point(
        data = lPitchControl$dtTrackingSlice[Tag != 'B'],
        aes(x = X, y = Y, color = Tag)
    ) +
    geom_pitch(cPitchColour = 'transparent', cLineColour = '#CCCCCC') +
    scale_fill_gradient2(midpoint = 0, high = 'blue', low = 'red') +
    theme_pitch()
    
print(p1)

```

There is some territory in the middle of the pitch where passing the ball is expected to return a positive `ExpectedAttackingDeltaPV_xy`. And then there is the tricky area near the opposition goal, which has a larger `ExpectedAttackingDeltaPV_xy` than the middle of the pitch. As a result of this problem, the logic above would suggest that in this situation the optimal action for the team in possession, the blue team, should be to pass the ball all the way to the goal and hope that the small chance of another player from the same team controlling the ball pays off for the high reward you'd get from successfully controlling the ball at that location.

```{r EPVIllustationTeamOptimal, echo=FALSE}

if ( F ) {
      
   p1 = p1 + 
      geom_tile(
           data = dtDetailsAggregated[Tag == lPitchControl$dtTrackingSlice[1, AttackingTeam]][which.max(TeamDeltaPV)],
           aes(
               x = TargetX,
               y = TargetY
           ),
           size = 10
       )
       
   print(p1)
   
}

```

### Full game 

I'll use game 1 from Metrica Sports' release available here - https://github.com/metrica-sports/sample-data/tree/master/data/Sample_Game_1 to show some uses for this approach.

#### Team - Distributions

Let us look at the proportion of the pitch that offers a net gain in expected PV for the attacking team. This is simply checking how much of the area of the pitch offers a positive `ExpectedAttackingDeltaPV_xy` at each instant the team had possession of the ball.

```{r PositiveProportion, echo=FALSE}

dtPositiveProportion = dtPVDelta[
   AttackingTeam == Team
][,
   .SD[1], 
   list(
     Frame, 
     AttackingTeam, 
     Team
  )
][, 
   .N, 
   list(AttackingTeam, Team, TeamPositiveProportion = round(floor(100*TeamPositiveProportion)/100,2))
][
   order(AttackingTeam, Team,TeamPositiveProportion)
][, 
   N_pct := N / sum(N), 
   list(AttackingTeam, Team)
]

dtPositiveProportion = merge(
   dtPositiveProportion[, 
      list(
         TeamPositiveProportion = round(seq(
            dtPositiveProportion[, min(TeamPositiveProportion)],
            dtPositiveProportion[, max(TeamPositiveProportion)],
            0.01
         ),2)
      ),
      list(AttackingTeam, Team)
   ],
   dtPositiveProportion,
   c('AttackingTeam', 'Team', 'TeamPositiveProportion'),
   all.x = T
)

dtPositiveProportion[is.na(N_pct), N_pct := 0]
dtPositiveProportion[, Type := 'Ideal']

pPositiveProportion = ggplot(dtPositiveProportion) + 
   geom_col(aes(x = TeamPositiveProportion, y = N_pct, fill = Team, group = Team), position = 'dodge') + 
   # geom_point(aes(x = TeamPositiveProportion, y = N_pct, color = Team)) +
   scale_colour_discrete(name = 'Team') +
   scale_y_continuous(labels = percent, name = 'Occurrence') +
   scale_x_continuous(labels = percent, name = 'Proportion of pitch area with a positive expected change in PV for the attacking team')

print(pPositiveProportion)

dtPositiveProportion0 = dtPVDelta[
    AttackingTeam == Team
][,
  .SD[1], 
  list(
      Frame, 
      AttackingTeam, 
      Team
  )
][, 
  .N, 
  list(AttackingTeam, Team, TeamPositiveProportionEq0 = TeamPositiveProportion == 0)
][, N_pct := N / sum(N), AttackingTeam]

dtPositiveProportion0 = dtPositiveProportion0[TeamPositiveProportionEq0 == T]

```

- Most of the time there is a very small part of the pitch, if at all, that offers a positive net expected delta PV for the attacking team. 
- 30% to 40% of the time there is less than 1% of the pitch which offers a positive `ExpectedAttackingDeltaPV_xy` for both the teams. It is exactly 0 in `r dtPositiveProportion0[AttackingTeam == 'H', round(100*N_pct)]`% when the home team has the ball and `r dtPositiveProportion0[AttackingTeam == 'A', round(100*N_pct)]`% when the away team has the ball. A value of 0% means the team in possession of the ball has no options on the pitch to pass to where they are expected to increase their chances of scoring by enough to negate the chance of conceding and have to pass it to lower possession value part of the pitch. This is very important because a number of times a pass is played to retain possession and not necessarily increase the chance of scoring and the typical way PV is applied would give these passes a negative score which is unfair. We will see how we can right this injustice later in the post.
- There is almost never a situation where more than 15% of the area of the pitch offers a positive `ExpectedAttackingDeltaPV_xy` for the attacking team.
- The away team usually has options over a bigger area of the pitch than the home team.

Let us look at the values of the `ExpectedAttackingDeltaPV_xy` itself. 

If the team were to randomly pass to any point on the pitch, at each instant of the game, what delta PV could they expect?

```{r AllEPV, echo=FALSE}

dtPV = dtPVDelta[
   AttackingTeam == Team
][,
  list(
     TeamDeltaPV = max(TeamDeltaPV)
  ), 
  list(
     Frame, 
     AttackingTeam, 
     Team
  )
][, 
  .N, 
  list(AttackingTeam, Team, TeamDeltaPV = round(floor(TeamDeltaPV*100)/100,2))
][
   order(AttackingTeam, Team, TeamDeltaPV)
][, 
  N_pct := N / sum(N), 
  list(AttackingTeam, Team)
]

dtPV = merge(
   dtPV[, 
      list(
         TeamDeltaPV = round(seq(
            dtPV[, min(TeamDeltaPV)],
            dtPV[, max(TeamDeltaPV)],
            0.01
         ),2)
      ),
      list(AttackingTeam, Team)
   ],
   dtPV,
   c('AttackingTeam', 'Team','TeamDeltaPV'),
   all.x = T
)

dtPV[is.na(N_pct), N_pct := 0]

ggplot(dtPV) + 
   geom_col(aes(x = TeamDeltaPV, y = N_pct, fill = Team, group = Team), position = 'dodge') + 
   # geom_point(aes(x = TeamDeltaPV, y = N_pct, color = Team)) +
   scale_y_continuous(labels = percent, name = 'Occurrence') +
   scale_x_continuous(labels = percent, name = 'Expected PV gain from random pass')

```

- From the earlier histogram, we saw most of the pitch usually offers a negative expected delta PV so it isn't surprising that this distribution is completely in the negative. What this means is that a random pass is more likely to help the defending team than an attacking team.

If we had a model to predict probabilities of passing to areas on the pitch that would have been nice but we don't. Instead, we'll look at the maximum `ExpectedAttackingDeltaPV_xy` at any instant as that number is more indicative of the best option to pass for the attacking team at any instant.

```{r PositiveEPV, echo=FALSE}

dtMaxPV = dtPVDelta[
   AttackingTeam == Team
][,
  list(
     TeamMaxDeltaPV = max(TeamMaxDeltaPV)
  ), 
  list(
     Frame, 
     AttackingTeam, 
     Team
  )
][, 
  .N, 
  list(AttackingTeam, Team, TeamMaxDeltaPV = round(floor(TeamMaxDeltaPV*100)/100,2))
][
   order(AttackingTeam, Team, TeamMaxDeltaPV)
][, 
  N_pct := N / sum(N), 
  list(AttackingTeam, Team)
]

dtMaxPV = merge(
   dtMaxPV[, 
      list(
         TeamMaxDeltaPV = round(seq(
            dtMaxPV[, min(TeamMaxDeltaPV)],
            dtMaxPV[, max(TeamMaxDeltaPV)],
            0.01
         ),2)
      ),
      list(AttackingTeam, Team)
   ],
   dtMaxPV,
   c('AttackingTeam', 'Team','TeamMaxDeltaPV'),
   all.x = T
)

dtMaxPV[is.na(N_pct), N_pct := 0]
dtMaxPV[, Facet := 'Ideal']

pMaxPV = ggplot() + 
  geom_col(
     data = copy(dtMaxPV)[, Facet := 'Realistic'],
     aes(x = TeamMaxDeltaPV, y = N_pct, fill = Team, group = Team), 
     position = 'dodge'
    ) + 
  scale_y_continuous(labels = percent, name = 'Occurrence') +
  scale_x_continuous(labels = percent, name = 'Max expected PV gain') 


print(pMaxPV)

```

Most of the time, the best option offers an `ExpectedAttackingDeltaPV_xy` between -1% and 2% for both teams:

```{r PositiveEPVLow, echo=FALSE}

print(
  kable(
    dtMaxPV[TeamMaxDeltaPV >= -0.01 & TeamMaxDeltaPV <= 0.02, list(HighTeamMaxDeltaPVRealistic_pct = paste0(100 * round(sum(N_pct),2), '%')), Team],
    format = 'html'
  )
)

```

The proportion of time above 2% is -

```{r PositiveEPVGT1, echo=FALSE}

(
  kable(
    dtMaxPV[TeamMaxDeltaPV >= -0.01 & TeamMaxDeltaPV > 0.02, list(LowTeamMaxDeltaPVRealistic_pct = paste0(100 * round(sum(N_pct),2), '%')), Team],
    format = 'html'
  )
)

```

While the gain in PV might be large if some of these passes are successful, when you balance them out for the probability of those passes being unsuccessful, then the team in possession doesn't usually have a chance to attempt an action which offers a high probability large gain in PV.

#### Team - observations in time

```{r PositiveEPVPlayerTimeline, echo=FALSE, warning=F, message=F}

ggplot(
   dtPVDelta[
      AttackingTeam == Team, 
      list(TeamMaxDeltaPV = max(TeamMaxDeltaPV)), 
      list(Frame, Team)
   ]
) + 
   geom_point(aes(x = Frame, y = TeamMaxDeltaPV, color = Team)) + 
   facet_wrap(~Team, ncol = 1) +
   scale_y_continuous(labels = percent)

```

- Most of the high value expected delta PV for the attacking team, for either of the teams, is concentrated in time, which means they are just multiple frames from a much fewer number of instances. For the most part the teams operate in a very low expected reward sort of situation.

- You can see some patterns across the game, for instance the home team had a couple of very good chances to progress the ball towards the start of the game and had other chances through the game as well, while the away team had many good chances to progress the ball towards the end of the game but not much during the earlier part of the game. 

#### Team - observations in space

The location of the highest expected delta PV at each instant during the sample of frames looks like as below.

```{r PitchTrend, echo=FALSE}

dtPitchTrend = dtPVDelta[
  Team == AttackingTeam
][, 
  .SD[1], 
  list(Frame)
]

dtPitchTrend = dtPitchTrend[,
  .N, 
  list(AttackingTeam, TeamMaxDeltaPVX, TeamMaxDeltaPVY)
]

dtPitchTrend[,
  N_pct := N / sum(N),
  list(AttackingTeam)
]

dtPitchTrend = merge(
  dtPitchTrend,
  data.table(
    expand.grid(
      AttackingTeam = dtPitchTrend[, unique(AttackingTeam)],
      TeamMaxDeltaPVX = seq(-nXSpan/2, nXSpan/2,1),
      TeamMaxDeltaPVY = seq(-nYSpan/2, nYSpan/2,1)
    )
  ),
  c('AttackingTeam','TeamMaxDeltaPVX','TeamMaxDeltaPVY'),
  all = T
)

dtPitchTrend[
  is.na(N),
  N := 0
]

dtPitchTrend[, N_pct := N / sum(N), list(AttackingTeam)]

pPitchTrend = ggplot() +
  geom_pitch(cLineColour = '#CCCCCC', cPitchColour = 'transparent') +
  geom_jitter(
    data = dtPitchTrend[N_pct != 0][, list(V1 = 1:N), list(TeamMaxDeltaPVX, TeamMaxDeltaPVY, AttackingTeam)],
    aes(
      x = TeamMaxDeltaPVX, y = TeamMaxDeltaPVY,
      # size = N_pct
    ), 
    size = 0.2, 
    width = 0.5,
    height = 0.5
    # color = 'black', 
    # fill = 'transparent', 
    # shape = 21
  ) +
  # scale_size_continuous(name = '% occurrence', labels = percent) +
  facet_wrap(~AttackingTeam) + 
  theme_pitch()

    
print(pPitchTrend)

```

- The home team creates a lot more opportunities to progress the ball through the central areas in their own half compared to the away team that relies more heavily on opportunities wider areas. Wider areas are usually much more popular as a target though.
- If you look at the area in the defensive halves, note how the away team more often presents the best opportunity towards the left, whereas the home team has better options more often on the right side deeper in their own half, and more often on the left side more advanced in their own half.

```{r OriginPVTrend, echo=FALSE}

if ( F ) {
      
   ggplot(dtPVDelta[Team == AttackingTeam][, .SD[1], list(Frame)]) +
       geom_point(aes(x = OriginPV, y = TeamMaxDeltaPV)) +
       facet_wrap(~Team) + 
       coord_fixed()
   
}
    
```

```{r OriginPVTrend, echo=FALSE}

if ( F ) {
    
  ggplot(
    dtPVDelta[AttackingTeam == Team,.SD[1],Frame][,
      list(
        TargetDistance = (
          ( ( TeamMaxDeltaPVX - BallX ) ^ 2 ) + ( ( TeamMaxDeltaPVX - BallY ) ^ 2 )
        ) ^ 0.5,
        TeamMaxDeltaPV
      )
    ]
  ) +
    geom_point(
      aes(
        x = TeamMaxDeltaPV,
        y = TargetDistance
      )
    )
  
}

```
### Instances of high positive expected delta PV

Let's see what sort of potential passes show up if we filter for the maximum `ExpectedAttackingDeltaPV_xy` value at any frame > TeamDeltaPVThreshold. Again, these are potential passes that _could_ have been played and not necessarily the actual pass that was played at the time. There may also have been more than one such pass at any frame but we will pick only the one with the maximum `ExpectedAttackingDeltaPV_xy` value. It's also likely that during the course of the play, a similar kind of pass continued to remain the optimal choice and you would therefore see it multiple times. We can figure out a way to isolate unique passes and I can keep track of other high value passes even if they aren't the optimal but for now this is all we have.

```{r OriginTarget, echo=FALSE}

dtOriginTarget = dtPVDelta[
  (TeamMaxDeltaPV) > TeamDeltaPVThreshold
][
  Team == AttackingTeam
][
  order(Frame)
][
  # c(T,diff(Frame) > 100)
][,
  .SD[1],
  Frame
]

dtOriginTarget[, Facet := 'Ideal']
dtOriginTarget[, TeamMaxDeltaPVX := TeamMaxDeltaPVX + ( ( runif(.N) - 0.5 ) / 2 )]
dtOriginTarget[, TeamMaxDeltaPVY := TeamMaxDeltaPVY + ( ( runif(.N) - 0.5 ) / 2 )]

pOriginTarget = ggplot() +
    geom_pitch(cLineColour = '#CCCCCC', cPitchColour = 'transparent') +
    geom_point(
        data = dtOriginTarget,
        aes(
            x = TeamMaxDeltaPVX,
            y = TeamMaxDeltaPVY
        )
    ) + 
    geom_segment(
      data = dtOriginTarget,
        aes(
            x = BallX,
            y = BallY,
            xend = TeamMaxDeltaPVX,
            yend = TeamMaxDeltaPVY
        ),
        alpha = 0.25
    ) + 
    facet_wrap(~Team) +
    theme_pitch()
    
print(pOriginTarget)

```

- Lots of diagonal balls from deep in the defensive half to the wings.
- Lots of good opportunities to cross from the deep left for the away team. 
- The home team has opportunities from all sorts of places to put the ball in the box. 
- The away team has quite a few of these high `ExpectedAttackingDeltaPV_xy` passes targeted towards the centre of the box whereas the home team has them spread all over the box.

## Adjusting for passing ability

A lot of the high positive expected delta PV passes are quite long passes, and long passes are likely to fetch more PV because it usually gets you much closer to the goal from where you were before. But it is also much harder to execute such passes. A player may want to aim for the most optimal target location but could end up playing the pass to an area near the the target. What we saw above accounts for intention, but we also need to account for exectuion to evaluate a more realistic `ExpectedAttackingDeltaPV_xy`.

To incorporate that, I add some noise to the pass end location as a function of the length of the pass. What this noise basically does is that it assumes that a pass targeted at a particular location x,y could go anywhere in the neighbourhood of x,y depending on how far x,y is from the pass origin location. The longer the pass, the more the magnitude of the noise. The noise is spread as a two dimensional gaussian around the target location being aimed at. This definitely needs more rigorous work, in terms of understanding the distribution of how a pass can be off target but this is a reasonable simple assumption to get started with to illustrate the concept at least.

The `ExpectedAttackingDeltaPV_xy` value now needs to be updated with the pitch control and the possession value of the neighbouring areas and the probability of the pass going to those neighbouring areas.

Once do that, here is how the numbers change. Not significantly, but slightly. I'm calling this set of numbers the actual numbers and the earlier set of numbers the ideal numbers.

```{r PositiveProportionRealistic, echo=FALSE}

dtPositiveProportion2 = dtPVDelta[
   AttackingTeam == Team
][,
   .SD[1], 
   list(
     Frame, 
     AttackingTeam, 
     Team
  )
][, 
   .N, 
   list(AttackingTeam, Team, TeamPositiveProportionRealistic = round(floor(100*TeamPositiveProportionRealistic)/100,2))
][
   order(AttackingTeam, Team, TeamPositiveProportionRealistic)
][, 
   N_pct := N / sum(N), 
   list(AttackingTeam, Team)
]

dtPositiveProportion2 = merge(
   dtPositiveProportion2[, 
      list(
         TeamPositiveProportionRealistic = round(seq(
            dtPositiveProportion2[, min(TeamPositiveProportionRealistic)],
            dtPositiveProportion2[, max(TeamPositiveProportionRealistic)],
            0.01
         ),2)
      ),
      list(AttackingTeam, Team)
   ],
   dtPositiveProportion2,
   c('AttackingTeam', 'Team','TeamPositiveProportionRealistic'),
   all.x = T
)

setnames(
  dtPositiveProportion2,'TeamPositiveProportionRealistic','TeamPositiveProportion'
)

dtPositiveProportion2[is.na(N_pct), N_pct := 0]

dtPositiveProportion = merge(
  dtPositiveProportion,
  dtPositiveProportion2,
  c('AttackingTeam','Team','TeamPositiveProportion'),
  suffixes = c('.ideal','.actual'),
  all = T
)

dtPositiveProportion[is.na(N_pct.ideal), N_pct.ideal := 0]
dtPositiveProportion[is.na(N_pct.actual), N_pct.actual := 0]
# dtPositiveProportion2[, Type := 'Realistic']

pPositiveProportion = ggplot() + 
   geom_col(
      data = copy(dtPositiveProportion)[, Facet := 'Ideal'],
      aes(x = TeamPositiveProportion, y = N_pct.ideal, fill = Team, group = Team), 
      position = 'dodge'
   ) + 
   geom_col(
      data = copy(dtPositiveProportion)[, Facet := 'Realistic - Ideal'],
      aes(x = TeamPositiveProportion, y = N_pct.actual - N_pct.ideal, fill = Team, group = Team), 
      position = 'dodge'
   ) + 
   geom_col(
      data = copy(dtPositiveProportion)[, Facet := 'Realistic'],
      aes(x = TeamPositiveProportion, y = N_pct.actual, fill = Team, group = Team), 
      position = 'dodge'
   ) + 
   # geom_point(aes(x = TeamPositiveProportion, y = N_pct, color = Team)) +
   scale_colour_discrete(name = 'Team') +
   scale_y_continuous(labels = percent, name = 'Occurrence') +
   scale_x_continuous(labels = percent, name = 'Proportion of pitch area with a positive expected change in PV for the attacking team') +
  facet_grid(Facet~.)

print(pPositiveProportion)
```

```{r PositiveEPVRealistic, echo=FALSE}

dtMaxPV2 = dtPVDelta[
   AttackingTeam == Team
][,
  list(
     TeamMaxDeltaPVRealistic = max(TeamMaxDeltaPVRealistic)
  ), 
  list(
     Frame, 
     AttackingTeam, 
     Team
  )
][, 
  .N, 
  list(AttackingTeam, Team, TeamMaxDeltaPVRealistic = round(floor(TeamMaxDeltaPVRealistic*100)/100,2))
][
   order(AttackingTeam, Team, TeamMaxDeltaPVRealistic)
][, 
  N_pct := N / sum(N), 
  list(AttackingTeam, Team)
]

dtMaxPV2 = merge(
   dtMaxPV2[, 
      list(
         TeamMaxDeltaPVRealistic = round(seq(
            dtMaxPV2[, min(TeamMaxDeltaPVRealistic)],
            dtMaxPV2[, max(TeamMaxDeltaPVRealistic)],
            0.01
         ),2)
      ),
      list(AttackingTeam, Team)
   ],
   dtMaxPV2,
   c('AttackingTeam', 'Team','TeamMaxDeltaPVRealistic'),
   all.x = T
)

dtMaxPV2[is.na(N_pct), N_pct := 0]
setnames(
  dtMaxPV2, 'TeamMaxDeltaPVRealistic','TeamMaxDeltaPV'
)
dtMaxPV = merge(
  dtMaxPV,
  dtMaxPV2,
  c('AttackingTeam','Team','TeamMaxDeltaPV'),
  suffixes = c('.ideal','.actual'),
  all = T
)

dtMaxPV[is.na(N_pct.ideal), N_pct.ideal := 0]
dtMaxPV[is.na(N_pct.actual), N_pct.actual := 0]

pMaxPV = ggplot() + 
  geom_col(
     data = copy(dtMaxPV)[, Facet := 'Realistic'],
     aes(x = TeamMaxDeltaPV, y = N_pct.actual, fill = Team, group = Team), 
     position = 'dodge'
    ) + 
  geom_col(
     data = copy(dtMaxPV)[, Facet := 'Ideal'],
     aes(x = TeamMaxDeltaPV, y = N_pct.ideal, fill = Team, group = Team), 
     position = 'dodge'
    ) + 
  geom_col(
     data = copy(dtMaxPV)[, Facet := 'Realistic - Ideal'],
     aes(x = TeamMaxDeltaPV, y = N_pct.actual - N_pct.ideal, fill = Team, group = Team), 
     position = 'dodge'
    ) + 
  scale_y_continuous(labels = percent, name = 'Occurrence') +
  scale_x_continuous(labels = percent, name = 'Max expected PV gain') + 
  facet_grid(Facet~.)

print(pMaxPV)

```

```{r PitchTrendRealistic, echo=FALSE}

dtPitchTrend2 = dtPVDelta[
  Team == AttackingTeam
][, 
  .SD[1], 
  list(Frame)
]

dtPitchTrend2 = dtPitchTrend2[,
  .N, 
  list(
    AttackingTeam, 
    TeamMaxDeltaPVX = TeamMaxDeltaPVRealisticX, 
    TeamMaxDeltaPVY = TeamMaxDeltaPVRealisticY
  )
]

dtPitchTrend2[,
  N_pct := N / sum(N),
  list(AttackingTeam)
]

dtPitchTrend = merge(
  dtPitchTrend2,
  dtPitchTrend,
  c('AttackingTeam','TeamMaxDeltaPVX','TeamMaxDeltaPVY'),
  all = T,
  suffixes = c('.actual','.ideal')
)

dtPitchTrend[
  is.na(N_pct.ideal),
  N_pct.ideal := 0
]

dtPitchTrend[
  is.na(N_pct.actual),
  N_pct.actual := 0
]

dtPitchTrend[, RealisticMinusIdeal := as.character(sign(N_pct.actual - N_pct.ideal))]
dtPitchTrend[RealisticMinusIdeal == '-1', RealisticMinusIdeal := '-']
dtPitchTrend[RealisticMinusIdeal == '1', RealisticMinusIdeal := '+']
dtPitchTrend[RealisticMinusIdeal == '0', RealisticMinusIdeal := '']

pPitchTrend = ggplot() +
    geom_pitch(cLineColour = '#CCCCCC', cPitchColour = 'transparent') +
    geom_jitter(
        data = dtPitchTrend[N_pct.ideal != 0][, list(V1 = 1:N.ideal, Facet = 'Ideal'), list(TeamMaxDeltaPVX, TeamMaxDeltaPVY, AttackingTeam)],
        aes(
            x = TeamMaxDeltaPVX, y = TeamMaxDeltaPVY,
            # size = N_pct
        ), 
        size = 0.2,
        color = 'black', 
        width = 0.5,
        height = 0.5
        # fill = 'transparent', 
        # shape = 21
    ) +
    geom_jitter(
        data = dtPitchTrend[N_pct.actual != 0][, list(V1 = 1:N.actual, Facet = 'Realistic'), list(TeamMaxDeltaPVX, TeamMaxDeltaPVY, AttackingTeam)],
        aes(
            x = TeamMaxDeltaPVX, y = TeamMaxDeltaPVY,
            # size = N_pct
        ), 
        size = 0.2,
        color = 'black', 
        width = 0.5,
        height = 0.5
        # fill = 'transparent', 
        # shape = 21
    ) +
    facet_grid(Facet~AttackingTeam) + 
    theme_pitch()

print(pPitchTrend)

    
```

```{r OriginTargetRealistic, echo=FALSE}

dtOriginTarget = dtPVDelta[(TeamMaxDeltaPVRealistic) > TeamDeltaPVThreshold][Team == AttackingTeam][order(Frame)][
  # c(T,diff(Frame) > 100)
][,
  .SD[1],
  Frame
]

dtOriginTarget[, Facet := 'Realistic']
dtOriginTarget[, TeamMaxDeltaPVX := TeamMaxDeltaPVX + ( ( runif(.N) - 0.5 ) / 2 )]
dtOriginTarget[, TeamMaxDeltaPVY := TeamMaxDeltaPVY + ( ( runif(.N) - 0.5 ) / 2 )]

pOriginTarget +
    # geom_pitch(cLineColour = '#CCCCCC', cPitchColour = 'transparent') +
    geom_point(
        data = dtOriginTarget,
        aes(
            x = TeamMaxDeltaPVRealisticX,
            y = TeamMaxDeltaPVRealisticY
        )
    ) + 
    geom_segment(
        data = dtOriginTarget,
        aes(
            x = BallX,
            y = BallY,
            xend = TeamMaxDeltaPVRealisticX,
            yend = TeamMaxDeltaPVRealisticY
        ),
        alpha = 0.25
    ) + 
    facet_grid(Facet~Team)
    
```

- The distributions don't move significantly but they do move a little bit towards the direction of lower possible gains. This makes sense, you'd expect Ã¥dding noise to reduce the optimal value.
- Note the slightly lesser instances of the model suggesting that the pass should be right at the goal mouth or even at the edge of the pitch on the wings. Because in those cases, there is a chance of the ball going out of bounds as well which would mean handing over the ball to the other team. This reduces how attractive those locations are and the optimal locations move a little inwards. How much they move inside is likely an artifact of the way the noise has been incorporated in the model though, because the locations are still clumped tightly

### Player level - Recipient

We calculated `ExpectedAttackingDeltaPV_xy` and `ExpectedDefendingDeltaPV_xy` at a team level above. We can now distribute that amongst the players of the attacking and defending team respectively in proportion to their pitch control probability at that part of the pitch:

- `PlayerExpectedAttackingDeltaPV_xy = ExpectedAttackingDeltaPV_xy * PlayerPitchControlProbability_xy / AttackingTeamPitchControlProbability_xy`
- `PlayerExpectedDefendingDeltaPV_xy = ExpectedDefendingDeltaPV_xy * PlayerPitchControlProbability_xy / DefendingTeamPitchControlProbability_xy`

The max of these values across the entire space of the pitch at each instant during the game tells us what is the best option an individual player offers. Various aggregations of these values over the game could give us an indication of the contribution of a player. 

We will use the actual version of the numbers and not the ideal version of the numbers.

```{r PositiveEPVPlayer, echo=FALSE}

dtPlayerLevelMetrics = merge(
   dtPVDelta[
      AttackingTeam == Team
   ][, 
     .N, 
     list(AttackingTeam, Team, Player, PlayerMaxDeltaPVRealistic = floor(100 * PlayerMaxDeltaPVRealistic)/100)
   ][
      order(AttackingTeam, Team, Player, PlayerMaxDeltaPVRealistic)
   ][, 
     N_pct := N / sum(N), 
     list(AttackingTeam, Team, Player)
   ],
   dtPlayerLabels,
   'Player'
)

dtPlayerLevelMetrics[,
   TeamLabel := factor(
      paste0(Team, ' - ', Label),
      levels = dtPlayerLevelMetrics[, 1, list(Team, Label)][order(Team, Label)][, paste(Team, '-', Label)],
      ordered = T
   )  
]

p1 = ggplot(dtPlayerLevelMetrics) + 
   geom_col(aes(x = PlayerMaxDeltaPVRealistic, y = N_pct, fill = Team, group = Team)) + 
   # geom_point(aes(x = PlayerMaxDeltaPVRealistic, y = N_pct, color = Team)) +
   scale_y_continuous(labels = percent, name = 'Occurrence') +
   scale_x_continuous(labels = percent, name = 'Max expected PV gain') +
   scale_fill_discrete(guide = F) +
   facet_wrap(~TeamLabel)

p1

```

The percent of time players offer a high ( > `r PlayerDeltaPVThreshold` ) `PlayerExpectedAttackingDeltaPV_xy` value:

```{r PositiveEPVPlayerGTXlim, echo=FALSE, warning=F, message=F}

kable(
  dtPlayerLevelMetrics[, 
    list(
      HighPlayerMaxDeltaPVRealistic_pct = sum(N_pct[PlayerMaxDeltaPVRealistic >= PlayerDeltaPVThreshold])
    ),
    list(Player = TeamLabel)
  ][
    order(-HighPlayerMaxDeltaPVRealistic_pct),
    list(
      HighPlayerMaxDeltaPVRealistic_pct = paste0(100 * round(HighPlayerMaxDeltaPVRealistic_pct,2),'%'),
      Player
    )
  ], format = 'html'
)

if  ( F ) {
    
  p1 + 
    scale_x_continuous(
      labels = percent, 
      name = 'Max expected PV gain', 
      limits = c(0.01, NA)
    )
  
}
```

- Again, almost all of it lies between -1% to 1%. 
- The away team is a little better than the home team though, with a higher proportion of occurrence in the 0% to 1% band and less in the -1% to 0% compared to the home team.

- The occurrence of high values is very low, which we could already have guessed from the team level distributions. 

The locations of high progression opportunities, `PlayerExpectedAttackingDeltaPV_xy` > 0.01, are as below -

```{r PositiveEPVPlayerGT1, echo=FALSE, warning=F, message=F, fig.height = 12}

dtPlayerLevelXY = merge(
   dtPVDelta[, 1, list(Player, Team)], 
   dtPVDelta[Team == AttackingTeam][PlayerMaxDeltaPVRealistic > 0.01], 
   c('Team','Player'),
   all.x = T
)

dtPlayerLevelXY = merge(
   dtPlayerLabels,
   dtPlayerLevelXY,
   'Player'
)

dtPlayerLevelXY[,
   TeamLabel := factor(
      paste0(Team, ' - ', Label),
      levels = dtPlayerLevelMetrics[, 1, list(Team, Label)][order(Team, Label)][, paste(Team, '-', Label)],
      ordered = T
   )  
]

ggplot(dtPlayerLevelXY) + 
   geom_pitch(cLineColour = '#CCCCCC', cPitchColour = 'transparent') +
   geom_jitter(aes(x= PlayerMaxDeltaPVRealisticX, y = PlayerMaxDeltaPVRealisticY), size = 0.2, width = 0.5, height = 0.5) +
   facet_wrap(~TeamLabel, ncol = 4) + 
   coord_fixed() + 
   scale_color_continuous(low = 'black', high = 'red') +
   theme_pitch()

```

When comparing metrics like how often a player receives progressive passes, using this as a baseline would help with a better assessment of players. If two players receive a similar number of progressive passes ( p90, adjusted for possesion, etc. ) with similar PV gain but if player 1 created far more opportunities to receive such passes than player 2 then player 1 needs to be given extra credit.

### Player level - Passer

Usually the passer is credited with the PV gained from a pass so we should also look at what opportunities the rest of the team presents to them, including the player in possession themselves.

```{r PositiveEPVPlayerPasser, echo=FALSE}

dtPlayerLevelMetrics = merge(
   dtPVDelta[
      AttackingTeam == Team
   ][,
     list(
       TeamMaxDeltaPVRealistic = max(TeamMaxDeltaPVRealistic)
     ),
     list(
       Frame,
       AttackingTeam, 
       Team,
       Player = PlayerInPossession
     )
   ][, 
     .N, 
     list(AttackingTeam, Team, Player, TeamMaxDeltaPVRealistic = floor(100 * TeamMaxDeltaPVRealistic)/100)
   ][
      order(AttackingTeam, Team, Player, TeamMaxDeltaPVRealistic)
   ][, 
     N_pct := N / sum(N), 
     list(AttackingTeam, Team, Player)
   ],
   dtPlayerLabels,
   'Player'
)

dtPlayerLevelMetrics[,
   TeamLabel := factor(
      paste0(Team, ' - ', Label),
      levels = dtPlayerLevelMetrics[, 1, list(Team, Label)][order(Team, Label)][, paste(Team, '-', Label)],
      ordered = T
   )  
]

p1 = ggplot(dtPlayerLevelMetrics) + 
   geom_col(aes(x = TeamMaxDeltaPVRealistic, y = N_pct, fill = Team, group = Team)) + 
   # geom_point(aes(x = TeamMaxDeltaPVRealistic, y = N_pct, color = Team)) +
   scale_y_continuous(labels = percent, name = 'Occurrence') +
   scale_x_continuous(labels = percent, name = 'Max expected PV gain') +
   facet_wrap(~TeamLabel)

p1

```

```{r PositiveEPVPlayerGTXlimPasser, echo=FALSE, warning=F, message=F}

kable(
  dtPlayerLevelMetrics[, 
    list(
      HighTeamMaxDeltaPVRealistic_pct = sum(N_pct[TeamMaxDeltaPVRealistic >= TeamDeltaPVThreshold])
    ),
    list(Player = TeamLabel)
  ][
    order(-HighTeamMaxDeltaPVRealistic_pct),
    list(
      HighTeamMaxDeltaPVRealistic_pct = paste0(100 * round(HighTeamMaxDeltaPVRealistic_pct,2),'%'),
      Player
    )
  ], format = 'html'
)

if ( F ) {
    
  p1 + 
    scale_x_continuous(
      labels = percent, 
      name = 'Max expected PV gain', 
      limits = c(0.01, NA)
    )

}
```

```{r PositiveEPVPlayerGT1Passer, echo=FALSE, warning=F, message=F, fig.height = 12}

dtPlayerLevelXY = merge(
   dtPVDelta[, 1, list(PlayerInPossession = Player, Team)], 
   dtPVDelta[Team == AttackingTeam][,.SD[1],list(Frame,Tag)][TeamMaxDeltaPVRealistic > TeamDeltaPVThreshold], 
   c('Team','PlayerInPossession'),
   all.x = T
)

dtPlayerLevelXY[, Player := NULL]

setnames(
  dtPlayerLevelXY,'PlayerInPossession','Player'
)

dtPlayerLevelXY = merge(
   dtPlayerLabels,
   dtPlayerLevelXY,
   'Player'
)

dtPlayerLevelXY[,
   TeamLabel := factor(
      paste0(Team, ' - ', Label),
      levels = dtPlayerLevelMetrics[, 1, list(Team, Label)][order(Team, Label)][, paste(Team, '-', Label)],
      ordered = T
   )  
]

ggplot(dtPlayerLevelXY) + 
   geom_pitch(cLineColour = '#CCCCCC', cPitchColour = 'transparent') +
   geom_jitter(aes(x= TeamMaxDeltaPVRealisticX, y = TeamMaxDeltaPVRealisticY), width = 0.5, height = 0.5) +
   facet_wrap(~TeamLabel, ncol = 4) + 
   coord_fixed() + 
   scale_color_continuous(low = 'black', high = 'red') +
   theme_pitch()

```

Helps interpret stats better just like how I explained it with receiving passes earlier, 

### Using Player Level Metrics To Evalaute Player Performance

Can consider each frame of ball possession as an event - which can be considered as either a pass or a carry or a shot. Integrate `ExpectedAttackingDeltaPV_xy` over each event and also integrate the actual delta PV attained from the actual action at each event and compare the two.

First from a passer's perspective -

```{r BestOpportunityDuringPossession, echo=FALSE, warning=F, message=F, fig.height = 12}

dtPossessions = dtPVDelta[Team == AttackingTeam][,.SD[1], Frame][order(Frame)]

dtPossessions[,
  ChangeInTeam := (c(tail(Team,-1) != head(Team,-1),1))
]

dtPossessions[,
  TeamPossessionID := cumsum(c(1,tail(ChangeInTeam,-1)))
]

dtPossessions[,
  PlayerPossessionID := cumsum(c(1, tail(PlayerInPossession,-1) != head(PlayerInPossession,-1)))
]

dtPossessions[,
  DeltaTime := c(diff(Frame), 0)
]

dtPossessions[, NextOriginPV := c(tail(OriginPV, -1), NA)]
dtPossessions[ChangeInTeam == T, NextOriginPV := -NextOriginPV]

# dtPVDelta[AttackingTeam == Team, .SD[1], list(Frame)][, .SD[which.max(TeamMaxDeltaPVRealistic)], PossessionID]

dtPlayerEvaluation = merge(
  dtPossessions[, 
    list(
      AchievedDeltaPV = sum(NextOriginPV - OriginPV, na.rm = T), 
      MaxDeltaPV = sum(TeamDeltaPVRealistic * DeltaTime) / DataFrequency_hz,
      TimeOnBall = sum(DeltaTime) / DataFrequency_hz
    ), 
    list(Team, Player = PlayerInPossession)
  ],
  dtPlayerLabels,
  'Player'
)

p1 = ggplot(dtPlayerEvaluation) + 
  geom_text(
    aes(x = AchievedDeltaPV/TimeOnBall, y =  MaxDeltaPV/TimeOnBall, label = Label, color = Team)
  ) +
  # geom_abline(aes(slope = 1, intercept = 0)) + 
  coord_fixed()

# print(p1)

p1 = ggplot(
  dtPlayerEvaluation[
    order((AchievedDeltaPV - MaxDeltaPV) / TimeOnBall), 
    list(
      Order = 1:.N,
      AchievedDeltaPV = AchievedDeltaPV/TimeOnBall,
      MaxDeltaPV = MaxDeltaPV/TimeOnBall,
      DeltaPerformance = (AchievedDeltaPV - MaxDeltaPV) / TimeOnBall,
      Label,
      Team
    )
  ]
) + 
    # geom_text(
    #     aes(x = DeltaPerformance, y = Order, label = Label, color = Team),
    #     # position = position_jitter(width = 0)
    # ) + 
    # geom_segment(
    #     aes(x = DeltaPerformance, xend = 0, yend = Order, y = Order, color = Team),
    #     # position = position_jitter(width = 0)
    # ) + 
    geom_text(
        aes(x = AchievedDeltaPV, y = Order, label = Label, color = Team),
        # position = position_jitter(width = 0)
        hjust = 1.2
    ) + 
    geom_segment(
        aes(x = AchievedDeltaPV, xend = MaxDeltaPV, yend = Order, y = Order, color = Team),
        # position = position_jitter(width = 0)
    ) + 
    geom_point(
        aes(x = MaxDeltaPV, y = Order, color = Team),
        # position = position_jitter(width = 0)
    ) +
    xlab('Average optimal expected delta PV (â¢) --- average achieved delta PV')

print(p1)


```

- Bottom right is the place to be in this for progressive passing talent - high delta PV achieved, low delta PV available to them during the game. The home team LCM and RW would get rated highly by this logic.
- Also, interestingly, most players are in the negative for both - on average nobody gets a very high opportunity to progress the ball nor do they achieve that.

At each stretch of possession for a player, they have multiple opportunities to play a pass. Using the metric of expected delta PV, we can find the `ExpectedAttackingDeltaPV_xy` of choices they had during that stretch of possession and compare it to the choice they finally made and how sub optimal that choice was. Players who have an eye for good passes should make choices close to optimal very often.
